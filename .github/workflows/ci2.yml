name: CI2

on: [ push , pull_request ]

jobs:

  # Building the library using opam
  opam-build:
    strategy:
      fail-fast: false
      matrix:
        coq-version:
          - '8.13'
          - 'latest'
          - 'dev'
        os:
          - ubuntu-latest
        ocaml-version:
          - '4.11-flambda'
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Build HoTT
        uses: coq-community/docker-coq-action@v1
        with:
          opam_file: 'hott.opam'
          coq_version: ${{ matrix.coq-version }}
          ocaml_version: ${{ matrix.ocaml-version }}

  # Quick build
  quick-build:
    strategy:
      fail-fast: false
      matrix:
        coq-version:
          - '8.13'
          - 'latest'
          - 'dev'
        os:
          - ubuntu-latest
        ocaml-version:
          - '4.11-flambda'
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Build HoTT
        uses: coq-community/docker-coq-action@v1
        with:
          coq_version: ${{ matrix.coq_version }}
          ocaml_version: ${{ matrix.ocaml_version }}
          custom_script: |
            startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
            sudo chown -R coq:coq .
            endGroup
            sudo apt-get -o Acquire::Retries=30 update -q
            sudo apt-get -o Acquire::Retries=30 install python -y --allow-unauthenticated
            make -j`nproc`
        
  # Main build which docs will run off
  build:
    strategy:
      fail-fast: false
      matrix:
        # We build on our supported version of coq and the master version
        coq_version:
          - '8.13'
          - 'latest'
          - 'dev'
        ocaml_version:
          - '4.11-flambda'
        include:
        - coq_version: 'dev'
          extra_gh_reportify: '--warnings'
    runs-on: ubuntu-latest
    steps:
    # Checkout branch
    - uses: actions/checkout@v2
    # Checkout submodules
    - uses: snickerbockers/submodules-init@v4
    # We use the coq docker so we don't have to build coq
    - uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ matrix.coq_version }}
        ocaml_version: ${{ matrix.ocaml_version }}
        custom_script: |
          startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
            sudo chown -R coq:coq .
          endGroup
          sudo apt-get -o Acquire::Retries=30 update -q
          sudo apt-get -o Acquire::Retries=30 install python -y --allow-unauthenticated
          make

    - name: Revert permissions
      # to avoid a warning at cleanup time - https://github.com/coq-community/docker-coq-action#permissions
      if: ${{ always() }}
      run: sudo chown -R 1001:116 .
    # Tar workspace files
    - name: 'Tar .vo files'
      run: tar -cvf workspace.tar .
    # We upload build artifacts for use by documentation
    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v2
      with:
        name: workspace-${{ matrix.coq_version }}
        path: workspace.tar   
    
  test-artifact:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        # We build on our supported version of coq and the master version
        coq_version: [ '8.13' , 'latest' , 'dev' ]
        ocaml_version: [ '4.11-flambda' ]
        include:
        - coq_version: 'dev'
          extra_gh_reportify: '--warnings'
    runs-on: ubuntu-latest
    steps:
    # Checkout branch
    - uses: actions/checkout@v2
    # Checkout submodules
    - uses: snickerbockers/submodules-init@v4
    # Download artifact
    - uses: actions/download-artifact@v2
      with:
        name: workspace-${{ matrix.coq_version }}
    # Unpack Tar
    - run: tar -xvf workspace.tar
    # We use the coq docker so we don't have to build coq
    - uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ matrix.coq_version }}
        ocaml_version: ${{ matrix.ocaml_version }}
        custom_script: |
          startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
            sudo chown -R coq:coq .
          endGroup
          sudo apt-get -o Acquire::Retries=30 update -q
          sudo apt-get -o Acquire::Retries=30 install python -y --allow-unauthenticated
          make
    - name: Revert permissions
      # to avoid a warning at cleanup time - https://github.com/coq-community/docker-coq-action#permissions
      if: ${{ always() }}
      run: sudo chown -R 1001:116 .
