name: CI2

on: [ push , pull_request ]

# We set the supported coq-version from here. In order to use this environment variable correctly, look at how they are used in the following jobs.
env:
  coq-version-supported: '8.13'

jobs:

## JOB 1

  # Building the library using opam
  opam-build:
    strategy:
      fail-fast: false
      matrix:
        coq-version-dummy:
          - 'supported'
          - 'latest'
          - 'dev'
        os:
          - ubuntu-latest
        ocaml-version:
          - '4.11-flambda'
    env:
      coq-version: ${{ matrix.coq-version-dummy }}    
    runs-on: ${{ matrix.os }}
    steps:
    # Github actions doesn't let us set workflow level enviornment variables inside the stategy of a job. Therefore we use the dummy variable coq-version in the matrix to set an environment varible env.coq-version, which uses the globablly set coq-version-supported when running the 'supported' case. 
    - name: Set supported coq-version
      if: matrix.coq-version == 'supported'
      run: echo "coq-version=${{ env.coq-version-supported }}" >> $GITHUB_ENV
        
    - name: Checkout repo
      uses: actions/checkout@v2
    - name: Build HoTT
      uses: coq-community/docker-coq-action@v1
      with:
        opam_file: 'hott.opam'
        coq_version: ${{ env.coq-version }}
        ocaml_version: ${{ matrix.ocaml-version }}

## JOB 2
        
  # Quick build
  quick-build:
    strategy:
      fail-fast: false
      matrix:
        coq-version-dummy:
          - 'supported'
          - 'latest'
          - 'dev'
        os:
          - ubuntu-latest
        ocaml-version:
          - '4.11-flambda'
    env:
      coq-version: ${{ matrix.coq-version-dummy }}    
    runs-on: ${{ matrix.os }}
    steps:
    # Github actions doesn't let us set workflow level enviornment variables inside the stategy of a job. Therefore we use the dummy variable coq-version in the matrix to set an environment varible env.coq-version, which uses the globablly set coq-version-supported when running the 'supported' case. 
    - name: Set supported coq-version
      if: matrix.coq-version == 'supported'
      run: echo "coq-version=${{ env.coq-version-supported }}" >> $GITHUB_ENV
    - name: Checkout repo
      uses: actions/checkout@v2
    - name: Build HoTT
      uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ env.coq-version }}
        ocaml_version: ${{ matrix.ocaml-version }}
        custom_script: |
          startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
          sudo chown -R coq:coq .
          endGroup
          # Use action script feature instead
          make -j`nproc`

## JOB 3
          
  # Main build which docs will run off
  build:
    strategy:
      fail-fast: false
      matrix:
        # We build on our supported version of coq and the master version
        coq_version-dummy:
          - 'supported'
          - 'latest'
          - 'dev'
        ocaml_version:
          - '4.11-flambda'
        include:
        - coq_version: 'dev'
          extra_gh_reportify: '--warnings'
    env:
      coq-version: ${{ matrix.coq-version-dummy }}    
    runs-on: ubuntu-latest
    steps:
    # Github actions doesn't let us set workflow level enviornment variables inside the stategy of a job. Therefore we use the dummy variable coq-version in the matrix to set an environment varible env.coq-version, which uses the globablly set coq-version-supported when running the 'supported' case. 
    - name: Set supported coq-version
      if: matrix.coq-version == 'supported'
      run: echo "coq-version=${{ env.coq-version-supported }}" >> $GITHUB_ENV
    # Checkout branch
    - uses: actions/checkout@v2
    # Checkout submodules
    - uses: snickerbockers/submodules-init@v4
    # We use the coq docker so we don't have to build coq
    - uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ env.coq_version }}
        ocaml_version: ${{ matrix.ocaml_version }}
        custom_script: |
          startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
            sudo chown -R coq:coq .
          endGroup
          sudo apt-get -o Acquire::Retries=30 update -q
          sudo apt-get -o Acquire::Retries=30 install python -y --allow-unauthenticated
          etc/coq-scripts/github/reportify-coq.sh --errors make TIMED=1 -j2 --output-sync GH_REPORT_ERRORS=1

    - name: Revert permissions
      # to avoid a warning at cleanup time - https://github.com/coq-community/docker-coq-action#permissions
      if: ${{ always() }}
      run: sudo chown -R 1001:116 .
    # Tar workspace files
    - name: 'Tar .vo files'
      run: tar -cvf workspace.tar .
    # We upload build artifacts for use by documentation
    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v2
      with:
        name: workspace-${{ matrix.coq_version }}
        path: workspace.tar   

## JOB 4
      
  # The coqchk job
  coqchk:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        # We build on our supported version of coq and the master version
        coq-version-dummy:
          - 'supported'
          - 'latest'
          - 'dev'
        ocaml-version:
          - '4.11-flambda'
        include:
        - coq-version: 'dev'
          extra_gh_reportify: '--warnings'
    env:
      coq-version: ${{ matrix.coq-version-dummy }}    
    runs-on: ubuntu-latest
    steps:
    # Github actions doesn't let us set workflow level enviornment variables inside the stategy of a job. Therefore we use the dummy variable coq-version in the matrix to set an environment varible env.coq-version, which uses the globablly set coq-version-supported when running the 'supported' case. 
    - name: Set supported coq-version
      if: matrix.coq-version == 'supported'
      run: echo "coq-version=${{ env.coq-version-supported }}" >> $GITHUB_ENV
    # Checkout branch
    - uses: actions/checkout@v2
    # Checkout submodules
    - uses: snickerbockers/submodules-init@v4
    # Download artifact
    - uses: actions/download-artifact@v2
      with:
        name: workspace-${{ env.coq-version }}
    # Unpack Tar
    - run: tar -xvf workspace.tar
    # We use the coq docker so we don't have to build coq
    - uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ env.coq-version }}
        ocaml_version: ${{ matrix.ocaml-version }}
        custom_script: |
          startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
            sudo chown -R coq:coq .
          endGroup
          make validate
    - name: Revert permissions
      # to avoid a warning at cleanup time - https://github.com/coq-community/docker-coq-action#permissions
      if: ${{ always() }}
      run: sudo chown -R 1001:116 .

## JOB 5
    
  test-artifact:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        # We build on our supported version of coq and the master version
        coq-version-dummy:
          - 'supported'
          #- 'latest'
          - 'dev'
        ocaml-version:
          - '4.11-flambda'
        include:
        - coq-version: 'dev'
          extra_gh_reportify: '--warnings'
    env:
      coq-version: ${{ matrix.coq-version-dummy }}    
    runs-on: ubuntu-latest
    steps:
    # Github actions doesn't let us set workflow level enviornment variables inside the stategy of a job. Therefore we use the dummy variable coq-version in the matrix to set an environment varible env.coq-version, which uses the globablly set coq-version-supported when running the 'supported' case. 
    - name: Set supported coq-version
      if: matrix.coq-version == 'supported'
      run: echo "coq-version=${{ env.coq-version-supported }}" >> $GITHUB_ENV
    # Checkout branch
    - uses: actions/checkout@v2
    # Checkout submodules
    - uses: snickerbockers/submodules-init@v4
    # Download artifact
    - uses: actions/download-artifact@v2
      with:
        name: workspace-${{ env.coq-version }}
    # Unpack Tar
    - run: tar -xvf workspace.tar
    # We use the coq docker so we don't have to build coq
    - uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ env.coq-version }}
        ocaml_version: ${{ matrix.ocaml-version }}
        custom_script: |
          startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
            sudo chown -R coq:coq .
          endGroup
          make
    - name: Revert permissions
      # to avoid a warning at cleanup time - https://github.com/coq-community/docker-coq-action#permissions
      if: ${{ always() }}
      run: sudo chown -R 1001:116 .

## JOB 6
    
  # alectryon job
  alectryon:
    needs: build
    strategy:
      matrix:
        coq-version-dummy:
          - 'supported'
        ocaml-version:
          - '4.11-flambda'
    env:
      coq-version: ${{ matrix.coq-version-dummy }}    
    runs-on: ubuntu-latest
    steps:
    # Github actions doesn't let us set workflow level enviornment variables inside the stategy of a job. Therefore we use the dummy variable coq-version in the matrix to set an environment varible env.coq-version, which uses the globablly set coq-version-supported when running the 'supported' case. 
    - name: Set supported coq-version
      if: matrix.coq-version == 'supported'
      run: echo "coq-version=${{ env.coq-version-supported }}" >> $GITHUB_ENV
    - uses: actions/checkout@v2
    - uses: snickerbockers/submodules-init@v4
    # Download artifact
    - uses: actions/download-artifact@v2
      with:
        name: workspace-${{ env.coq-version }}
    # Unpack Tar
    - run: tar -xvf workspace.tar
    - name: add problem matchers
      run: |
        #echo "::add-matcher::etc/coq-scripts/github/coq-oneline-error.json" # now via a script
        #echo "::add-matcher::etc/coq-scripts/github/coqdoc.json" # disabled for now, since they don't have file names
        echo "::add-matcher::etc/coq-scripts/github/alectryon-error.json"
        #echo "::add-matcher::etc/coq-scripts/github/alectryon-warning.json" # too noisy right now, cf https://github.com/cpitclaudel/alectryon/issues/34 and https://github.com/cpitclaudel/alectryon/issues/33
    - uses: coq-community/docker-coq-action@v1
      with:
        coq_version: ${{ env.coq-version }}
        ocaml_version: 4.11-flambda
        custom_script: |
          opam install -y coq-serapi
          sudo apt-get -o Acquire::Retries=30 update -q
          sudo apt-get -o Acquire::Retries=30 install python3-pip autoconf -y --allow-unauthenticated
          python3 -m pip install --user --upgrade pygments dominate beautifulsoup4 docutils
          startGroup "Workaround permission issue" # https://github.com/coq-community/docker-coq-action#permissions
            sudo chown -R coq:coq .
          endGroup
          make alectryon ALECTRYON_EXTRAFLAGS=--traceback
    - name: Revert permissions
      # to avoid a warning at cleanup time - https://github.com/coq-community/docker-coq-action#permissions
      if: ${{ always() }}
      run: sudo chown -R 1001:116 .
    - name: tar alectryon artifact
      run: tar -cvf alectryon-html.tar alectryon-html
    - name: upload alectryon artifact
      uses: actions/upload-artifact@v1
      with:
        name: alectryon-html.tar
        path: alectryon-html.tar

