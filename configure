#!/bin/sh

OPTFILE="_CoqProject"

USE_IR=true
if [ "${1}" = "NO_IR" ]
then USE_IR=false
fi

if [ -z "${HOQDIR}" ]
then if which hoqc > /dev/null && which hoqtop > /dev/null && which hoqdep > /dev/null;
     then
         HOQC=$(which hoqc);
         HOQTOP=$(which hoqtop);
         HOQDEP=$(which hoqdep);
         echo 'hoq* executables from PATH'
     else
         >&2 echo "HOQDIR not set and hoqc, hoqtop or hoqdep not in path"
         exit 1
     fi
else
    # if HOQDIR is set do not check that it's full
    HOQC="$HOQDIR/hoqc";
    HOQTOP="$HOQDIR/hoqtop";
    HOQDEP="$HOQDIR/hoqdep";
    echo 'hoq* scripts from HOQDIR:' "$HOQDIR"
fi

if [ -z "${COQMAKEFILE}" ];
then if which coq_makefile
     then
         COQMAKEFILE=$(which coq_makefile)
         echo "coq_makefile from PATH"
     else
         >&2 echo "coq_makefile not found and COQMAKEFILE not set"
         exit 1
     fi
else echo "coq_makefile from COQMAKEFILE"
fi


cp "$OPTFILE.in" "$OPTFILE"

echo "COQC = $HOQC" >> "$OPTFILE"
echo "COQDEP = $HOQDEP" >> "$OPTFILE"

#non IR find
#HoTTBook and CPP depend on IR
find ./theories -not \( -path './theories/IR' -prune \) -not -name CPP2017.v -not -name HoTTBook.v -name '*.v' -print >> "$OPTFILE"
if $USE_IR
then
    find ./theories/IR/ -name '*.v' >> "$OPTFILE"
    echo ./theories/CPP2017.v >> "$OPTFILE"
    echo ./theories/HoTTBook.v >> "$OPTFILE"
    echo "Compiling files in theories/IR"
else echo "Not compiling files in theories/IR"
fi

"$COQMAKEFILE" -f "$OPTFILE" -o Makefile || exit 1

echo "((coq-mode . ((coq-prog-name . \"$HOQTOP\"))))" > .dir-locals.el

echo "$0 success!"
